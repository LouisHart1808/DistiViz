<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>DistiViz</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
</head>
<body>

  <!-- Navbar -->
  <nav>
    <div class="navbar-container">
      <h1>DistiViz</h1>
      <ul>
        <li><a href="#" id="nav-apps" class="active">Distributors' Applications</a></li>
        <li><a href="#" id="nav-dregs">Distributors' DREGs</a></li>
        <li><a href="#" id="nav-compare">Distributor Verifier</a></li>
        <li><a href="#" id="nav-campaign">Campaign Conversion Checker</a></li>
      </ul>
      <button id="darkModeToggle" aria-label="Toggle Dark Mode">ðŸŒ™</button>
    </div>
  </nav>

  <!-- Regional Map Overview -->
  <section id="regionalMapSection" style="margin: 24px 0;">
    <h2>Geographic Distribution of DREGs</h2>
    <!-- DREGs Workbook Upload -->
    <div class="step dreg-upload" style="margin: 12px 0 18px;">
      <h3>Upload DREGs Excel Workbook</h3>
      <div class="upload-area" role="button" tabindex="0" aria-label="Upload DREGs Excel file" onclick="document.getElementById('dregExcelInput').click()">
        <div class="upload-icon" aria-hidden="true">ðŸ“„</div>
        <p><strong>Click to upload or drag &amp; drop your Excel workbook</strong></p>
        <p><strong>Only the sheet:</strong> <code>Data</code> will be used. Column <code>MAIN DISTRIBUTOR</code> will be renamed to <code>Distributor</code>. Region filtered to <code>AP</code>. Dummy rows dropped.</p>
      </div>
      <input type="file" id="dregExcelInput" accept=".xlsx,.xls,.xlsb,.csv" style="display:none;" />
      <div id="dregUploadStatus" class="upload-status" aria-live="polite"></div>
    </div>
    <div style="display: flex; align-items: center; gap: 20px; flex-wrap: wrap;">
      <label>
        View Metric:
        <select id="mapMetricSelect">
          <option value="DREGs">DREG Count</option>
          <option value="Revenue">Total Revenue (3y)</option>
        </select>
      </label>
      <label>
        Start Year:
        <select id="mapStartYearSelect"></select>
      </label>
      <label>
        End Year:
        <select id="mapEndYearSelect"></select>
      </label>
    </div>
    <div id="regionalMap" style="margin-top: 12px;"></div>
  </section>

  <section id="topCountriesChartSection" style="margin: 24px 0; display: none;">
    <div id="topCountriesChart"></div>
  </section>

  <!-- DREG Chart: Total per Distributor -->
  <section id="distributorBarChartContainer" style="margin: 24px 0; display: none;">
    <h2>Aggregated Total Data of Distributors</h2>
    <div id="distributorBarChart"></div>
    <div id="revenueBarChart"></div>

    <!-- Annual DREGs Section -->
    <section id="annualDregsSection" style="margin-top: 24px;">
      <h2>Annual DREGs of Distributor</h2>
      <div id="annualFilterRow" style="display: flex; flex-direction: row; align-items: center; gap: 20px; flex-wrap: wrap; margin-bottom: 12px;">
        <label style="display: flex; flex-direction: column;">
          Select Distributor:
          <select id="annualDistributorSelect"></select>
        </label>
        <label style="display: flex; flex-direction: column;">
          Select Segment:
          <select id="annualSegmentSelect"></select>
        </label>
      </div>
      <div id="annualDregsChart"></div>
      <div id="annualRevenueChart"></div>
    </section>
  </section>

  <!-- Applications Filters -->
  <section id="app-filters">
    <div class="step" style="margin-top: 12px;">
      <h3>Upload Applications Excel Workbook</h3>
      <div class="upload-area" role="button" tabindex="0" aria-label="Upload applications Excel file" onclick="document.getElementById('appsExcelInput').click()">
        <div class="upload-icon" aria-hidden="true">ðŸ“„</div>
        <p><strong>Click to upload or drag &amp; drop your Excel workbook</strong></p>
        <p><strong>Expected:</strong> Sheet <code>2-Confidence Level Focus Appl.</code> with columns Region, Distributor, ID, System/Application Level III, System/Application Level II, Application List Light Application, Lead DIV, Confidence.</p>
      </div>
      <input type="file" id="appsExcelInput" accept=".xlsx,.xls" style="display:none;" />
      <div id="appsUploadStatus" class="upload-status" aria-live="polite"></div>
    </div>

    <label for="regionSelect">Region:</label>
    <select id="regionSelect"></select>

    <label for="level3Select">System/Application Level III:</label>
    <select id="level3Select"></select>

    <div class="slider-group">
      <label for="scoreSlider">Min Confidence:</label>
      <div class="slider-wrapper">
        <input type="range" id="scoreSlider" min="0" max="100" value="0" step="10" />
        <span id="scoreValue">0</span>
      </div>
    </div>
  </section>

  <!-- DREG Filters -->
  <section id="dreg-filters" style="display: none;">
    <h2>DREGs Between Approval and Campaign Dates</h2>

    <label for="distributorSelect">Distributor:</label>
    <select id="distributorSelect"></select>

    <label for="regStatusSelect">Reg Status:</label>
    <select id="regStatusSelect"></select>

    <label for="approvalDate">Approval Date up to:</label>
    <input type="date" id="approvalDate" />

    <label for="campaignDate">Campaign Date:</label>
    <input type="date" id="campaignDate" />

    <label>
      <input type="checkbox" id="hasCampaignDate" checked />
      Filter by Campaign Date
    </label>
  </section>

  <!-- DREG Breakdown Chart -->
  <section id="dreg-breakdown-section" style="margin-top: 12px; display: none;">
    <label for="breakdownSelect">Group DREGs By:</label>
    <select id="breakdownSelect">
      <option value="Segment">Segment</option>
      <option value="Subregion Resp">Subregion</option>
    </select>
    <div id="dregBreakdownChart"></div>
    <div id="revenueBreakdownChart"></div>
  </section>

  <!-- Shared Bar Chart -->
  <section id="barChart"></section>

  <!-- Dynamic Results Area -->
  <section id="results"></section>

  <!-- Tooltip -->
  <div id="tooltip" class="tooltip"></div>

  <!-- Campaign Conversion Checker Module -->
  <section id="campaignCheckerSection" style="display: none; margin: 24px 0;">

    <!-- Step 1: Upload Master File -->
    <div class="step">
      <h3>Step 1: Upload Master Excel File</h3>
      <div class="upload-area" role="button" tabindex="0" aria-label="Upload master Excel file" onclick="document.getElementById('masterFile').click()">
        <div class="upload-icon" aria-hidden="true">ðŸ“„</div>
        <p><strong>Click to upload or drag &amp; drop your master Excel file</strong></p>
        <p>Should contain: Registration ID, Main Distributor, Registration Date, Resale Customer, Country Resale Customer</p>
      </div>
      <input type="file" id="masterFile" accept=".xlsx,.xls" style="display: none;" />
      <div id="masterStatus"></div>
    </div>

    <!-- Step 2: Upload Campaign File -->
    <div class="step">
      <h3>Step 2: Upload Campaign-Specific Excel File</h3>
      <div class="upload-area" role="button" tabindex="0" aria-label="Upload campaign Excel file" onclick="document.getElementById('campaignFile').click()">
        <div class="upload-icon" aria-hidden="true">ðŸ“„</div>
        <p><strong>Click to upload or drag &amp; drop your campaign Excel file</strong></p>
        <p><strong>Required format:</strong> First Name, Last Name, Email, Company</p>
      </div>
      <input type="file" id="campaignFile" accept=".xlsx,.xls" style="display: none;" />
      <div id="campaignStatus"></div>
      <div class="note">
        <strong>Note:</strong> Campaign file should be in the stated format with columns: First Name, Last Name, Email, Company (case-insensitive)
      </div>
    </div>

    <!-- Step 3: Campaign Details -->
    <div class="form-group">
      <label for="startDate">Campaign Start Date:</label>
      <input type="date" id="startDate" required />
    </div>

    <div class="form-group">
      <label for="queryPeriod">Query Period (days after start date):</label>
      <select id="queryPeriod" required>
        <option value="">-- Select Period --</option>
        <option value="30">30 Days</option>
        <option value="60">60 Days</option>
        <option value="90">90 Days</option>
        <option value="180" selected>180 Days (Default)</option>
      </select>
    </div>

    <div class="form-group">
      <label for="distributor">Select Distributor:</label>
      <select id="distributor" required>
        <option value="">-- Select Distributor --</option>
      </select>
    </div>

    <div class="form-group">
      <label for="country">Target Country:</label>
      <select id="country" required>
        <option value="">-- Select Country --</option>
      </select>
    </div>

    <button class="btn" id="queryBtn" disabled aria-disabled="true">Find Matching Opportunities</button>
  </section>

  <!-- Compare Module -->
  <section id="compareSection" style="display: none; margin: 24px 0;">
    <h2>Compare Applications vs DREGs</h2>
    <p class="note">
      This module uses the data you already uploaded into the Applications and DREGs modules.
      Select a Distributor and Segment to compare aggregated insights.
      Options reflect the intersection of both datasets.
    </p>

    <div class="compare-filters" style="display: flex; gap: 20px; align-items: center; flex-wrap: wrap; margin: 16px 0;">
      <label style="display: flex; flex-direction: column; min-width: 280px;">
        Distributor:
        <div class="input-wrapper">
          <select id="compareDistributorSelect" disabled>
            <option value="">-- Select Distributor --</option>
          </select>
        </div>
      </label>
      <label style="display: flex; flex-direction: column; min-width: 280px;">
        Segment:
        <div class="input-wrapper">
          <div class="ms-dropdown">
            <button type="button" class="ms-toggle">Select Segments (0)</button>
            <div id="compareSegmentPicker" class="ms-container" aria-label="Select one or more segments" hidden></div>
          </div>
        </div>
      </label>

      <div class="slider-group" style="flex: 1 1 100%; width: 100%;">
        <label for="compareScoreSlider">Min Confidence:</label>
        <div class="slider-wrapper">
          <input type="range" id="compareScoreSlider" min="0" max="100" value="0" step="10" />
          <span id="compareScoreValue">0</span>
        </div>
      </div>
    </div>
    <div class="compare-actions" style="margin-top: 12px;">
      <button class="btn" id="compareRunBtn" disabled aria-disabled="true">Run Comparison</button>
    </div>

    <!-- Summary KPIs -->
    <div id="compareSummary" class="map-card" style="margin: 12px 0;">
      <h3 class="map-title">Summary</h3>
      <div class="kpi-row" id="compareSummaryContent"></div>
    </div>

    <!-- Charts Row -->
    <div class="results-grid" style="margin-top: 12px;">
      <div class="results-section">
        <h3>Top Application Areas & DREG Segments</h3>
        <div id="compareTopAreasChart"></div>
      </div>
    </div>

    <!-- Detail Tables -->
    <div class="results-grid" style="margin-top: 12px;">
      <div class="results-section">
        <div id="compareAppsTable"></div>
      </div>
      <div class="results-section">
        <div id="compareDregsTable"></div>
      </div>
    </div>

    <!-- Loading Spinner -->
    <div class="loading" id="compareLoading" aria-live="polite">
      <div class="spinner" aria-hidden="true"></div>
      <p>Building your comparisonâ€¦</p>
    </div>
  </section>

  <script type="module" src="scripts/main.js"></script>
  <script type="module" src="scripts/compareModule.js"></script>
</body>
</html>
